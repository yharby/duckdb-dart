name: Build Android Libraries

on:
  workflow_dispatch:
    inputs:
      duckdb_version:
        description: 'DuckDB version to build (leave empty for latest)'
        required: false
        default: ''
      create_release:
        description: 'Create a GitHub release'
        type: boolean
        default: true
  schedule:
    # Check for new DuckDB releases weekly (Sundays at 1am, after iOS build)
    - cron: '0 1 * * 0'

env:
  DUCKDB_REPO: duckdb/duckdb

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      duckdb_version: ${{ steps.get_version.outputs.version }}
      should_build: ${{ steps.check_existing.outputs.should_build }}
      release_tag: ${{ steps.get_version.outputs.release_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get DuckDB version
        id: get_version
        run: |
          if [ -n "${{ github.event.inputs.duckdb_version }}" ]; then
            VERSION="${{ github.event.inputs.duckdb_version }}"
          else
            # Get latest DuckDB release version
            VERSION=$(curl -s https://api.github.com/repos/${{ env.DUCKDB_REPO }}/releases/latest | jq -r '.tag_name // empty' | sed 's/^v//')
            # Fallback if API fails
            if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
              echo "Warning: Could not fetch latest version from GitHub API, using fallback"
              VERSION="1.4.3"
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release_tag=v${VERSION}-android" >> $GITHUB_OUTPUT
          echo "DuckDB version: $VERSION"

      - name: Check if release already exists
        id: check_existing
        run: |
          RELEASE_TAG="v${{ steps.get_version.outputs.version }}-android"
          if gh release view "$RELEASE_TAG" --repo ${{ github.repository }} &>/dev/null; then
            echo "Release $RELEASE_TAG already exists"
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "Release $RELEASE_TAG does not exist, will build"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-android:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        abi: [arm64-v8a, armeabi-v7a, x86_64]
        include:
          - abi: arm64-v8a
            duckdb_platform: linux_arm64
          - abi: armeabi-v7a
            duckdb_platform: linux_arm64
          - abi: x86_64
            duckdb_platform: linux_amd64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26b

      - name: Install Ninja
        run: sudo apt-get install -y ninja-build

      - name: Download OpenSSL and cURL for Android
        run: |
          # Download pre-built OpenSSL and cURL static libraries from robertying/openssl-curl-android
          # This provides OpenSSL 1.1.1l and curl 7.78.0 static libs for all Android ABIs
          curl -L -o openssl-curl.tar.gz "https://github.com/robertying/openssl-curl-android/releases/download/1.1.1l-7.78.0/build.tar.gz"
          tar xzf openssl-curl.tar.gz

          # Verify structure
          echo "=== OpenSSL for ${{ matrix.abi }} ==="
          ls -la build/openssl/${{ matrix.abi }}/lib/
          echo "=== cURL for ${{ matrix.abi }} ==="
          ls -la build/curl/${{ matrix.abi }}/lib/

      - name: Download DuckDB source
        run: |
          DUCKDB_VERSION="${{ needs.check-version.outputs.duckdb_version }}"
          echo "Building DuckDB version: $DUCKDB_VERSION for ${{ matrix.abi }}"
          curl -L -o duckdb.zip "https://github.com/${{ env.DUCKDB_REPO }}/archive/refs/tags/v${DUCKDB_VERSION}.zip"
          unzip duckdb.zip
          mv duckdb-${DUCKDB_VERSION} duckdb-src

      - name: Build Android library
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          # Set DUCKDB_PLATFORM to avoid cross-compile platform detection issue
          # The duckdb_platform_binary is built for Android but runs on host
          DUCKDB_PLATFORM: ${{ matrix.duckdb_platform }}
        run: |
          cd duckdb-src
          mkdir -p build
          cd build

          # Set OpenSSL and cURL paths for the current ABI
          OPENSSL_ROOT=$(pwd)/../../build/openssl/${{ matrix.abi }}
          CURL_ROOT=$(pwd)/../../build/curl/${{ matrix.abi }}

          # Build with icu, parquet, json, httpfs extensions statically linked into libduckdb.so
          # Note: We do NOT use EXTENSION_STATIC_BUILD as that builds loadable .duckdb_extension files
          # which fail to link against static OpenSSL due to stdin/stderr symbol issues
          cmake -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-21 \
            -DANDROID_STL=c++_static \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DBUILD_SHARED_LIBS=ON \
            -DBUILD_UNITTESTS=OFF \
            -DBUILD_SHELL=OFF \
            -DBUILD_EXTENSIONS="icu;parquet;json;httpfs" \
            -DENABLE_EXTENSION_AUTOLOADING=OFF \
            -DENABLE_EXTENSION_AUTOINSTALL=OFF \
            -DDUCKDB_EXTRA_LINK_FLAGS="-llog" \
            -DDUCKDB_EXPLICIT_PLATFORM=${{ matrix.duckdb_platform }} \
            -DOPENSSL_ROOT_DIR=$OPENSSL_ROOT \
            -DOPENSSL_INCLUDE_DIR=$OPENSSL_ROOT/include \
            -DOPENSSL_CRYPTO_LIBRARY=$OPENSSL_ROOT/lib/libcrypto.a \
            -DOPENSSL_SSL_LIBRARY=$OPENSSL_ROOT/lib/libssl.a \
            -DOPENSSL_USE_STATIC_LIBS=TRUE \
            -DCURL_INCLUDE_DIR=$CURL_ROOT/include \
            -DCURL_LIBRARY=$CURL_ROOT/lib/libcurl.a \
            ..

          cmake --build . --config Release --parallel

          # Strip debug symbols to reduce size
          $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip --strip-debug src/libduckdb.so

      - name: Package library
        run: |
          mkdir -p output
          cp duckdb-src/build/src/libduckdb.so output/
          cd output
          zip libduckdb-android_${{ matrix.abi }}.zip libduckdb.so
          echo "Library size: $(du -h libduckdb-android_${{ matrix.abi }}.zip | cut -f1)"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libduckdb-android_${{ matrix.abi }}
          path: output/libduckdb-android_${{ matrix.abi }}.zip

  create-release:
    needs: [check-version, build-android]
    if: github.event.inputs.create_release != 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f -name "*.zip"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check-version.outputs.release_tag }}
          name: "DuckDB ${{ needs.check-version.outputs.duckdb_version }} Android Libraries"
          body: |
            Pre-built DuckDB Android libraries for version ${{ needs.check-version.outputs.duckdb_version }}.

            **Architectures:**
            - arm64-v8a (64-bit ARM devices)
            - armeabi-v7a (32-bit ARM devices)
            - x86_64 (x86 emulator)

            **Minimum Android SDK:** 21
            **Extensions (statically linked):**
            - `icu` - Unicode/collation support
            - `json` - JSON parsing and querying
            - `parquet` - Parquet file format support
            - `httpfs` - HTTP/HTTPS and S3 file system support

            Built automatically from [duckdb/duckdb v${{ needs.check-version.outputs.duckdb_version }}](https://github.com/duckdb/duckdb/releases/tag/v${{ needs.check-version.outputs.duckdb_version }})

            **Note:** For geospatial features (spatial), see the separate spatial build workflow.
          files: |
            artifacts/libduckdb-android_arm64-v8a/libduckdb-android_arm64-v8a.zip
            artifacts/libduckdb-android_armeabi-v7a/libduckdb-android_armeabi-v7a.zip
            artifacts/libduckdb-android_x86_64/libduckdb-android_x86_64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
