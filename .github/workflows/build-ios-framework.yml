name: Build iOS Framework

on:
  workflow_dispatch:
    inputs:
      duckdb_version:
        description: 'DuckDB version to build (leave empty for latest)'
        required: false
        default: ''
      create_release:
        description: 'Create a GitHub release'
        type: boolean
        default: true
      build_spatial:
        description: 'Build with spatial extension (experimental)'
        type: boolean
        default: false
  schedule:
    # Check for new DuckDB releases weekly (Sundays at midnight)
    - cron: '0 0 * * 0'

env:
  DUCKDB_REPO: duckdb/duckdb
  # Core extensions to include (built-in to DuckDB source)
  CORE_EXTENSIONS: "icu;json;parquet;httpfs"

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      duckdb_version: ${{ steps.get_version.outputs.version }}
      should_build: ${{ steps.check_existing.outputs.should_build }}
      release_tag: ${{ steps.get_version.outputs.release_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get DuckDB version
        id: get_version
        run: |
          if [ -n "${{ github.event.inputs.duckdb_version }}" ]; then
            VERSION="${{ github.event.inputs.duckdb_version }}"
          else
            # Get latest DuckDB release version
            VERSION=$(curl -s https://api.github.com/repos/${{ env.DUCKDB_REPO }}/releases/latest | jq -r '.tag_name // empty' | sed 's/^v//')
            # Fallback if API fails
            if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
              echo "Warning: Could not fetch latest version from GitHub API, using fallback"
              VERSION="1.4.3"
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release_tag=v${VERSION}-ios" >> $GITHUB_OUTPUT
          echo "DuckDB version: $VERSION"

      - name: Check if release already exists
        id: check_existing
        run: |
          RELEASE_TAG="v${{ steps.get_version.outputs.version }}-ios"
          if gh release view "$RELEASE_TAG" --repo ${{ github.repository }} &>/dev/null; then
            echo "Release $RELEASE_TAG already exists"
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "Release $RELEASE_TAG does not exist, will build"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-ios:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install Ninja
        run: brew install ninja

      - name: Download OpenSSL and cURL for iOS
        run: |
          # Download pre-built OpenSSL and cURL static libraries from jasonacox/Build-OpenSSL-cURL
          # This provides OpenSSL 3.x and libcurl static libs for iOS (required by httpfs extension)
          OPENSSL_PACKAGE="libcurl-8.11.1-openssl-3.0.15-nghttp2-1.64.0"
          curl -L "https://github.com/jasonacox/Build-OpenSSL-cURL/releases/download/1.0.1/${OPENSSL_PACKAGE}.tgz" | tar xzf -

          # Create OpenSSL directory structure that CMake expects
          # For iOS device (arm64)
          mkdir -p openssl-ios/lib openssl-ios/include
          cp ${OPENSSL_PACKAGE}/lib/iOS/libssl.a openssl-ios/lib/
          cp ${OPENSSL_PACKAGE}/lib/iOS/libcrypto.a openssl-ios/lib/
          cp -r ${OPENSSL_PACKAGE}/include/openssl openssl-ios/include/

          # For iOS simulator (arm64 + x86_64)
          mkdir -p openssl-sim/lib openssl-sim/include
          cp ${OPENSSL_PACKAGE}/lib/iOS-simulator/libssl.a openssl-sim/lib/
          cp ${OPENSSL_PACKAGE}/lib/iOS-simulator/libcrypto.a openssl-sim/lib/
          cp -r ${OPENSSL_PACKAGE}/include/openssl openssl-sim/include/

          # Create cURL directory structure for iOS device
          mkdir -p curl-ios/lib curl-ios/include
          cp ${OPENSSL_PACKAGE}/lib/iOS/libcurl.a curl-ios/lib/
          cp -r ${OPENSSL_PACKAGE}/include/curl curl-ios/include/

          # Create cURL directory structure for iOS simulator
          mkdir -p curl-sim/lib curl-sim/include
          cp ${OPENSSL_PACKAGE}/lib/iOS-simulator/libcurl.a curl-sim/lib/
          cp -r ${OPENSSL_PACKAGE}/include/curl curl-sim/include/

          # Verify structure
          echo "=== iOS Device Libraries ==="
          ls -la openssl-ios/lib/
          ls -la curl-ios/lib/
          echo "=== iOS Simulator Libraries ==="
          ls -la openssl-sim/lib/
          ls -la curl-sim/lib/
          file curl-sim/lib/libcurl.a

          # Set environment variables for CMake
          echo "OPENSSL_ROOT_DIR_IOS=$(pwd)/openssl-ios" >> $GITHUB_ENV
          echo "OPENSSL_ROOT_DIR_SIM=$(pwd)/openssl-sim" >> $GITHUB_ENV
          echo "CURL_ROOT_DIR_IOS=$(pwd)/curl-ios" >> $GITHUB_ENV
          echo "CURL_ROOT_DIR_SIM=$(pwd)/curl-sim" >> $GITHUB_ENV

      - name: Clone DuckDB source
        run: |
          DUCKDB_VERSION="${{ needs.check-version.outputs.duckdb_version }}"
          echo "Building DuckDB version: $DUCKDB_VERSION"
          # Use git clone instead of zip download to properly handle symbolic links
          git clone --depth 1 --branch "v${DUCKDB_VERSION}" "https://github.com/${{ env.DUCKDB_REPO }}.git" duckdb-src

      - name: Build iOS Framework (arm64)
        env:
          # Set DUCKDB_PLATFORM to avoid cross-compile platform detection issue
          # The duckdb_platform_binary is built for iOS but needs to run on macOS host
          DUCKDB_PLATFORM: osx_arm64
        run: |
          cd duckdb-src
          mkdir -p build/ios-arm64
          cd build/ios-arm64

          # Build with core extensions statically linked for iOS
          # Using Ninja generator to avoid Xcode code signing requirements
          # Extensions: icu (unicode), json, parquet (columnar storage), httpfs (HTTP/S3)
          cmake ../.. \
            -G Ninja \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHELL=OFF \
            -DBUILD_UNITTESTS=OFF \
            -DEXTENSION_STATIC_BUILD=ON \
            -DENABLE_EXTENSION_AUTOLOADING=OFF \
            -DENABLE_EXTENSION_AUTOINSTALL=OFF \
            -DBUILD_EXTENSIONS="${{ env.CORE_EXTENSIONS }}" \
            -DDUCKDB_EXPLICIT_PLATFORM=osx_arm64 \
            -DOPENSSL_ROOT_DIR=$OPENSSL_ROOT_DIR_IOS \
            -DOPENSSL_INCLUDE_DIR=$OPENSSL_ROOT_DIR_IOS/include \
            -DOPENSSL_CRYPTO_LIBRARY=$OPENSSL_ROOT_DIR_IOS/lib/libcrypto.a \
            -DOPENSSL_SSL_LIBRARY=$OPENSSL_ROOT_DIR_IOS/lib/libssl.a \
            -DOPENSSL_USE_STATIC_LIBS=TRUE \
            -DCURL_INCLUDE_DIR=$CURL_ROOT_DIR_IOS/include \
            -DCURL_LIBRARY=$CURL_ROOT_DIR_IOS/lib/libcurl.a

          cmake --build . --parallel

      - name: Build iOS Simulator Framework (arm64 + x86_64)
        env:
          DUCKDB_PLATFORM: osx_arm64
        run: |
          cd duckdb-src

          # Build arm64 simulator
          mkdir -p build/ios-simulator-arm64
          cd build/ios-simulator-arm64
          cmake ../.. \
            -G Ninja \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=iphonesimulator \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHELL=OFF \
            -DBUILD_UNITTESTS=OFF \
            -DEXTENSION_STATIC_BUILD=ON \
            -DENABLE_EXTENSION_AUTOLOADING=OFF \
            -DENABLE_EXTENSION_AUTOINSTALL=OFF \
            -DBUILD_EXTENSIONS="${{ env.CORE_EXTENSIONS }}" \
            -DDUCKDB_EXPLICIT_PLATFORM=osx_arm64 \
            -DOPENSSL_ROOT_DIR=$OPENSSL_ROOT_DIR_SIM \
            -DOPENSSL_INCLUDE_DIR=$OPENSSL_ROOT_DIR_SIM/include \
            -DOPENSSL_CRYPTO_LIBRARY=$OPENSSL_ROOT_DIR_SIM/lib/libcrypto.a \
            -DOPENSSL_SSL_LIBRARY=$OPENSSL_ROOT_DIR_SIM/lib/libssl.a \
            -DOPENSSL_USE_STATIC_LIBS=TRUE \
            -DCURL_INCLUDE_DIR=$CURL_ROOT_DIR_SIM/include \
            -DCURL_LIBRARY=$CURL_ROOT_DIR_SIM/lib/libcurl.a
          cmake --build . --parallel
          cd ..

          # Build x86_64 simulator
          mkdir -p ios-simulator-x86_64
          cd ios-simulator-x86_64
          cmake ../.. \
            -G Ninja \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=iphonesimulator \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHELL=OFF \
            -DBUILD_UNITTESTS=OFF \
            -DEXTENSION_STATIC_BUILD=ON \
            -DENABLE_EXTENSION_AUTOLOADING=OFF \
            -DENABLE_EXTENSION_AUTOINSTALL=OFF \
            -DBUILD_EXTENSIONS="${{ env.CORE_EXTENSIONS }}" \
            -DDUCKDB_EXPLICIT_PLATFORM=osx_amd64 \
            -DOPENSSL_ROOT_DIR=$OPENSSL_ROOT_DIR_SIM \
            -DOPENSSL_INCLUDE_DIR=$OPENSSL_ROOT_DIR_SIM/include \
            -DOPENSSL_CRYPTO_LIBRARY=$OPENSSL_ROOT_DIR_SIM/lib/libcrypto.a \
            -DOPENSSL_SSL_LIBRARY=$OPENSSL_ROOT_DIR_SIM/lib/libssl.a \
            -DOPENSSL_USE_STATIC_LIBS=TRUE \
            -DCURL_INCLUDE_DIR=$CURL_ROOT_DIR_SIM/include \
            -DCURL_LIBRARY=$CURL_ROOT_DIR_SIM/lib/libcurl.a
          cmake --build . --parallel

      - name: Create Frameworks and XCFramework
        run: |
          DUCKDB_VERSION="${{ needs.check-version.outputs.duckdb_version }}"

          # Find libraries
          DEVICE_LIB=$(find duckdb-src/build/ios-arm64 -name "libduckdb.a" -o -name "libduckdb_static.a" | head -1)
          SIM_ARM64=$(find duckdb-src/build/ios-simulator-arm64 -name "libduckdb.a" -o -name "libduckdb_static.a" 2>/dev/null | head -1)
          SIM_X86=$(find duckdb-src/build/ios-simulator-x86_64 -name "libduckdb.a" -o -name "libduckdb_static.a" 2>/dev/null | head -1)

          if [ -z "$DEVICE_LIB" ]; then
            echo "ERROR: Could not find device library"
            find duckdb-src/build/ios-arm64 -name "*.a" 2>/dev/null | head -10
            exit 1
          fi
          echo "Found device library: $DEVICE_LIB"

          # Create Info.plist template
          create_info_plist() {
            cat > "$1" << PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleExecutable</key>
            <string>duckdb</string>
            <key>CFBundleIdentifier</key>
            <string>org.duckdb.duckdb</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundleName</key>
            <string>duckdb</string>
            <key>CFBundlePackageType</key>
            <string>FMWK</string>
            <key>CFBundleShortVersionString</key>
            <string>${DUCKDB_VERSION}</string>
            <key>CFBundleVersion</key>
            <string>${DUCKDB_VERSION}</string>
            <key>MinimumOSVersion</key>
            <string>12.0</string>
          </dict>
          </plist>
          PLIST
          }

          # Create device framework
          mkdir -p duckdb-device.framework/Headers
          cp duckdb-src/src/include/duckdb.h duckdb-device.framework/Headers/
          cp "$DEVICE_LIB" duckdb-device.framework/duckdb
          create_info_plist duckdb-device.framework/Info.plist

          # Create simulator framework with fat binary (arm64 + x86_64)
          if [ -n "$SIM_ARM64" ] && [ -n "$SIM_X86" ]; then
            echo "Creating fat simulator library..."
            mkdir -p duckdb-simulator.framework/Headers
            cp duckdb-src/src/include/duckdb.h duckdb-simulator.framework/Headers/
            lipo -create "$SIM_ARM64" "$SIM_X86" -output duckdb-simulator.framework/duckdb
            create_info_plist duckdb-simulator.framework/Info.plist
            echo "Simulator fat library created"
          fi

          # Create XCFramework combining device and simulator
          if [ -d "duckdb-simulator.framework" ]; then
            xcodebuild -create-xcframework \
              -library duckdb-device.framework/duckdb -headers duckdb-device.framework/Headers \
              -library duckdb-simulator.framework/duckdb -headers duckdb-simulator.framework/Headers \
              -output duckdb.xcframework
            echo "XCFramework created with device and simulator support"
          else
            # Fallback: create XCFramework with device only
            xcodebuild -create-xcframework \
              -library duckdb-device.framework/duckdb -headers duckdb-device.framework/Headers \
              -output duckdb.xcframework
            echo "XCFramework created with device support only"
          fi

          # Also create a simple framework for backwards compatibility
          # This uses the simulator library for development convenience
          mkdir -p duckdb.framework/Headers
          cp duckdb-src/src/include/duckdb.h duckdb.framework/Headers/
          if [ -d "duckdb-simulator.framework" ]; then
            cp duckdb-simulator.framework/duckdb duckdb.framework/duckdb
          else
            cp "$DEVICE_LIB" duckdb.framework/duckdb
          fi
          create_info_plist duckdb.framework/Info.plist

      - name: Package Framework
        run: |
          # Package both XCFramework and regular framework
          zip -r duckdb-framework-ios.zip duckdb.framework
          zip -r duckdb-xcframework-ios.zip duckdb.xcframework
          echo "Framework size: $(du -h duckdb-framework-ios.zip | cut -f1)"
          echo "XCFramework size: $(du -h duckdb-xcframework-ios.zip | cut -f1)"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: duckdb-framework-ios
          path: |
            duckdb-framework-ios.zip
            duckdb-xcframework-ios.zip

      - name: Create GitHub Release
        if: github.event.inputs.create_release != 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check-version.outputs.release_tag }}
          name: "DuckDB ${{ needs.check-version.outputs.duckdb_version }} iOS Framework"
          body: |
            Pre-built DuckDB iOS framework for version ${{ needs.check-version.outputs.duckdb_version }}.

            **Downloads:**
            - `duckdb-framework-ios.zip` - Simple framework with simulator support (for development)
            - `duckdb-xcframework-ios.zip` - XCFramework with both device and simulator (recommended for production)

            **Architectures:** arm64 (device), arm64+x86_64 (simulator)
            **Minimum iOS:** 12.0
            **Extensions (statically linked):**
            - `icu` - Unicode/collation support
            - `json` - JSON parsing and querying
            - `parquet` - Parquet file format support
            - `httpfs` - HTTP/HTTPS and S3 file system support

            Built automatically from [duckdb/duckdb v${{ needs.check-version.outputs.duckdb_version }}](https://github.com/duckdb/duckdb/releases/tag/v${{ needs.check-version.outputs.duckdb_version }})

            **Note:** For geospatial features (spatial, h3), see the separate spatial build workflow.
          files: |
            duckdb-framework-ios.zip
            duckdb-xcframework-ios.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
